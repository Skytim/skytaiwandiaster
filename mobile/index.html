<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<link href="gk/lib/jquery.mobile/1.4.5/flatui/jquery.mobile.flatui.css" rel="stylesheet" type="text/css">
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script> 
<!-- Uncomment the following to include cordova in your android project --><!--<script src="http://jqmdesigner.appspot.com/platforms/android/cordova.js"></script>--><!-- GK Loader use RequireJS to load module -->
<script src="docs/release/2.1.11/minified/require.js"></script>
<!--Plug in GK-->
<script src="components/jquery.gk/jquery.gk.min.js"></script>
<!-- Load GK components -->
<script components="components/gk-ext/gk-position.html" callback="mobileInitPage" src="components/gk-loader/gk-loader.js"></script>
<!-- Export JS  -->
<script>   
$(document).on("mobileinit", function () {     
    $.mobile.autoInitializePage = false;     
    $.mobile.hashListeningEnabled = false;   });   
    function mobileInitPage() {     
        $.mobile.hashListeningEnabled = true;     
        $.mobile.initializePage();   };</script>
 
        <script>/*** code gen by gk-position  ***/ ;
$(document).on("gkComponentsReady", function () {
  var map = $('#map');
  var Latitude="";
  var Longitude="";
  var firstlatitude="";
  var firstlongitude="";
  function onSuccess(position) {
    Latitude = position.coords.latitude;
    Longitude = position.coords.longitude;
    map.tinyMap({
      'center': {
        'x': Latitude,
        'y': Longitude
      },
      zoom: 13,
       'marker': [{
         addr:[Latitude,Longitude]
      }]
    });
  }

  
  function onError(error) {
    // onError Callback receives a PositionError object  
  }
  if (navigator.geolocation) {
     navigator.geolocation.getCurrentPosition(showPosition);


    var watchID = navigator.geolocation.watchPosition(onSuccess, onError, {
      timeout: 10000
    });
  }
  function showPosition(position) {
     firstlatitude=position.coords.latitude;
     firstlongitude=position.coords.longitude;
     refugeplacefunction(firstlatitude,firstlongitude);
}
 


 function refugeplacefunction(x,y){
  var geocodingAPI = "http://maps.google.com/maps/api/geocode/json?latlng="+x+","+y+"&language=zh-TW";
  var nowplace="";
  var mykml="";
 
      $.getJSON(geocodingAPI, function (json) {
        var i=json.results[0].address_components.length;
        while(0<i){  
          if(json.results[0].address_components[i-1].types[0]=="administrative_area_level_1"){       
               nowplace=json.results[0].address_components[i-1].long_name;

                mykml="http://skytaiwandb.azurewebsites.net/mobile/kmz/refugeplace/"+nowplace+".kmz";
                $('#map').tinyMap('panto',nowplace);
                $('#map').tinyMap('clear','kml');
                $('#map').tinyMap('modify',{
                                  zoom:11,
                                  kml: mykml
                                 });
               // break;
               }
          i--;
        }
      });
    $("#refugeplace")
    .change(function () {
      var str = "";
      var locationtext ="";
      $("#refugeplace option:selected").each(function () {
        str= $(this).text();
         $('#map').tinyMap('panto',str);
         $('#map').tinyMap('clear','kml');
         $('#map').tinyMap('clear','marker');
         $('#map').tinyMap('modify',{
          zoom:11,
          kml: "http://skytaiwandb.azurewebsites.net/mobile/kmz/refugeplace/"+str+".kmz"
         });
      });
    })
    .change();

    $("#landslidesstreams")
    .change(function () {
      var str = "";
      var locationtext ="";
      $("#landslidesstreams option:selected").each(function () {
        str= $(this).text();
         $('#map').tinyMap('panto',str);
         $('#map').tinyMap('clear','kml');
         $('#map').tinyMap('clear','marker');
         $('#map').tinyMap('modify',{
          zoom:11,
          kml: "http://skytaiwandb.azurewebsites.net/mobile/kmz/landslidesstreams/"+str+".kmz"
         });
      });
    })
    .change();
}


});</script>

<title>疏散避難點與路線</title></head><body gk-app=""><!-- Page: home  --><div id="home" data-role="page">
  <script src="http://maps.google.com/maps/api/js?sensor=false?language=zh-TW?region=zh-TW"></script>
  <script src="http://app.essoduke.org/tinyMap/jquery.tinyMap-2.8.2.min.js"></script>
  <div data-role="header" data-position="fixed" data-theme="b">
    <h3>避難路線系統</h3>
    <a href="#" data-role="button" class="ui-btn-right">搜索</a>
    <a class="ui-btn ui-btn-left ui-btn-icon-left ui-icon-arrow-r" href="#left-menu" style="padding:18px; background:none;"></a>
  </div>
  <div id="left-menu" data-role="panel" data-position="left" data-position-fixed="false" data-theme="a">
    <div class="ui-field-contain">
      <p>疏散避難點與路線</p>
      <select id="refugeplace">
            <option value="yilan">&#x5B9C;&#x862D;&#x7E23;</option>
            <option value="keelung">&#x57FA;&#x9686;&#x5E02;</option>
            <option value="taipei">&#x53F0;&#x5317;&#x5E02;</option>
            <option value="new_taipei">&#x65B0;&#x5317;&#x5E02;</option>
            <option value="taoyuan">&#x6843;&#x5712;&#x5E02;</option>
            <option value="hsinchu">&#x65B0;&#x7AF9;&#x7E23;</option>
            <option value="miaoli">&#x82D7;&#x6817;&#x7E23;</option>
            <option value="taichung">台中市</option>
            <option value="changhua">&#x5F70;&#x5316;&#x7E23;</option>
            <option value="nantou">&#x5357;&#x6295;&#x7E23;</option>
            <option value="yunlin">&#x96F2;&#x6797;&#x7E23;</option>
            <option value="chiayi">&#x5609;&#x7FA9;&#x7E23;</option>
            <option value="tainan">&#x53F0;&#x5357;&#x5E02;</option>
            <option value="kaohsiung">&#x9AD8;&#x96C4;&#x5E02;</option>
            <option value="pingtung">&#x5C4F;&#x6771;&#x7E23;</option>
            <option value="taitung">&#x53F0;&#x6771;&#x7E23;</option>
            <option value="hualien">&#x82B1;&#x84EE;&#x7E23;</option>
      </select>
      <p>土石流潛勢溪流</p>
      <select id="landslidesstreams">
            <option value="yilan">&#x5B9C;&#x862D;&#x7E23;</option>
            <option value="keelung">&#x57FA;&#x9686;&#x5E02;</option>
            <option value="taipei">&#x53F0;&#x5317;&#x5E02;</option>
            <option value="new_taipei">&#x65B0;&#x5317;&#x5E02;</option>
            <option value="taoyuan">&#x6843;&#x5712;&#x5E02;</option>
            <option value="hsinchu">&#x65B0;&#x7AF9;&#x7E23;</option>
            <option value="miaoli">&#x82D7;&#x6817;&#x7E23;</option>
            <option value="taichung">台中市</option>
            <option value="changhua">&#x5F70;&#x5316;&#x7E23;</option>
            <option value="nantou">&#x5357;&#x6295;&#x7E23;</option>
            <option value="yunlin">&#x96F2;&#x6797;&#x7E23;</option>
            <option value="chiayi">&#x5609;&#x7FA9;&#x7E23;</option>
            <option value="tainan">&#x53F0;&#x5357;&#x5E02;</option>
            <option value="kaohsiung">&#x9AD8;&#x96C4;&#x5E02;</option>
            <option value="pingtung">&#x5C4F;&#x6771;&#x7E23;</option>
            <option value="taitung">&#x53F0;&#x6771;&#x7E23;</option>
            <option value="hualien">&#x82B1;&#x84EE;&#x7E23;</option>
      </select>
    </div>
  </div>
  <div role="main" class="ui-content">
    <div id="gk-1013XzQG" is="gk-position"></div>
    <div id="map" style="width:100%;height:400px"></div>
  </div>
  <div data-role="footer" data-position="fixed">
    <h3>WTS</h3>
  </div>
</div>
</body></html>
